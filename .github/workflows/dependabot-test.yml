name: Dependabot Test (Reusable)

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        type: string
        default: '20'
      go-version:
        description: 'Go version to use'
        type: string
        default: '1.21'
      dependabot-config-path:
        description: 'Path to dependabot.yml file'
        type: string
        default: '.github/dependabot.yml'
    outputs:
      result-summary:
        description: 'Summary of Dependabot test results'
        value: ${{ jobs.test.outputs.summary }}

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.generate-summary.outputs.summary }}
    
    steps:
      - name: Checkout calling repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install yaml parser
        run: npm install yaml

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - name: Install Dependabot CLI
        run: go install github.com/dependabot/cli/cmd/dependabot@latest

      - name: Verify dependabot.yml exists
        run: |
          if [ ! -f "${{ inputs.dependabot-config-path }}" ]; then
            echo "Error: dependabot.yml not found at ${{ inputs.dependabot-config-path }}"
            exit 1
          fi

      - name: Convert dependabot.yml to CLI format and run
        run: |
          node << 'EOF'
          const fs = require('fs');
          const yaml = require('yaml');

          const configPath = '${{ inputs.dependabot-config-path }}';
          const config = yaml.parse(fs.readFileSync(configPath, 'utf8'));

          for (const update of config.updates) {
            const pm = update['package-ecosystem'];
            const dir = update.directory || '/';

            const job = {
              job: {
                'package-manager': pm,
                'allowed-updates': [{ 'update-type': 'all' }],
                source: {
                  provider: 'github',
                  repo: '${{ github.repository }}',
                  directory: dir
                }
              }
            };

            // Add ignore conditions
            if (update.ignore) {
              job.job['ignore-conditions'] = update.ignore.map(i => ({
                'dependency-name': i['dependency-name'],
                'update-types': i['update-types']
              }));
            }

            // Add dependency groups
            if (update.groups) {
              job.job['dependency-groups'] = Object.entries(update.groups).map(([name, cfg]) => ({
                name,
                rules: { patterns: cfg.patterns || ['*'] }
              }));
            }

            const filename = `job-${pm}.yml`;
            fs.writeFileSync(filename, yaml.stringify(job));
            console.log(`Created ${filename} for ${pm} in ${dir}`);
          }
          EOF

      - name: Run simulations
        run: |
          for f in job-*.yml; do
            pm="${f#job-}"
            pm="${pm%.yml}"
            echo "=== Simulating $pm ==="
            cat "$f"
            echo "---"
            dependabot update -f "$f" --local . -o "output-$pm.yml" || true
          done
        continue-on-error: true

      - name: Show results
        id: generate-summary
        run: |
          node << 'EOF'
          const fs = require('fs');
          const yaml = require('yaml');
          const files = fs.readdirSync('.').filter(f => f.startsWith('output-') && f.endsWith('.yml'));

          console.log('## Packages that would be updated\n');

          let summary = '## Dependabot Test Results\n\n';

          for (const file of files) {
            const pm = file.replace('output-', '').replace('.yml', '');
            console.log(`### ${pm}\n`);
            summary += `### ${pm}\n\n`;

            try {
              const content = fs.readFileSync(file, 'utf8');
              if (!content.trim()) {
                console.log('No output file\n');
                summary += 'No output file\n\n';
                continue;
              }

              const data = yaml.parse(content);
              const updates = new Map();

              const output = data?.output || [];
              for (const item of output) {
                if (item?.type === 'create_pull_request' && item?.expect?.data?.dependencies) {
                  for (const dep of item.expect.data.dependencies) {
                    const key = dep.name;
                    const prev = dep['previous-version'] || '?';
                    const next = dep.version || '?';
                    updates.set(key, `${prev} â†’ ${next}`);
                  }
                }
              }

              if (updates.size === 0) {
                console.log('No updates found\n');
                summary += 'No updates found\n\n';
              } else {
                for (const [name, ver] of updates) {
                  const line = `- ${name}: ${ver}`;
                  console.log(line);
                  summary += line + '\n';
                }
                summary += '\n';
              }
            } catch (e) {
              console.log(`Parse error: ${e.message}\n`);
              summary += `Parse error: ${e.message}\n\n`;
            }
          }

          // Export summary for output
          const summaryEscaped = summary.replace(/%/g, '%25').replace(/\n/g, '%0A').replace(/\r/g, '%0D');
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `summary=${summaryEscaped}\n`);
          EOF

      - name: Upload job files
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependabot-job-files
          path: job-*.yml
          retention-days: 7

      - name: Upload output files
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependabot-output-files
          path: output-*.yml
          retention-days: 7
